<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<style>
.room {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-gap: 10px;
  grid-auto-flow: column dense;
  grid-auto-rows: minmax(20px, auto);
}
.name {
  font-size: xx-large;
  grid-column: 1 / 5;
  grid-row: 1;
  border-bottom: 2px solid black;
  padding-bottom: 2px;
}
.hand {
  grid-column: 1;
  grid-row: 2 / 4;
}
.hole {
  border-right: 2px solid black;
  border-bottom: 2px solid black;
  padding-bottom: 2px;
}
/*
.community {
  grid-column: 1;
  grid-row: 3;
}
*/
.gamestate {
  grid-column: 2 / 4;
  grid-row: 2 / 6;
}
.players {
  grid-column: 4;
  grid-row: 2 / 3;
}
.log {
  grid-column: 4;
  grid-row: 3 / 6;
}
.active {
  animation:blinkingText 1.2s infinite;
}
@keyframes blinkingText{
    0%{     color: #000;    }
    49%{    color: #000; }
    60%{    color: transparent; }
    99%{    color:transparent;  }
    100%{   color: #000;    }
}

table, th, td {
  border: 1px solid black;
}
th, td {
  padding: 6px;
}
</style>
    </head>
    <body>
        <div class="room">
            <div class="name">
                Welcome <input id="player_name" type="text" value="Enter your Name" style="font-size: xx-large"> to Poker!
            </div>
            <div class="hand">
                <h2>Your Hand</h2>
                <div class='hole'><span id="hole_cards" style="font-size: 1000%"></div>
                <div><span id="community_cards" style="font-size: 800%"></div>
            </div>
            <div class="gamestate" style="font-size: 200%">
                Your Bet: <input id="bet" type="text">
                <pre id="game" />
            </div>
            <div class="log" style="font-size: 150%">
                <h2>Game Log </h3>
                <pre id="log" />
            </div>
            <div class="players" style="font-size: 150%">
                <h2>Players In Room</h3>
                <pre id="players" />
            </div>
        </div>
        <script type="text/javascript">
"use strict";
var room_name = location.pathname.split("/").pop();
var game_elem = document.getElementById("game");
var players_elem = document.getElementById("players");
var log_elem = document.getElementById("log");
var name_elem = document.getElementById("player_name");
var name_set = false;
var hole_cards_elem = document.getElementById("hole_cards");
var community_cards_elem = document.getElementById("community_cards");
var seen_room = false;
var fetch_handle = null;
var next_index = "0";

function schedule_fetch(timeout) {
    clearTimeout(fetch_handle);
    fetch_handle = setTimeout(fetch_state, timeout);
}

function pretty_print(input) {
    var text = document.createTextNode(JSON.stringify(input, undefined, 2));
    var p = document.createElement("p");
    p.appendChild(text)
    return PR.prettyPrintOne(p.innerHTML, "js");
}

function addHeader(row, value) {
    const header = document.createElement("th");
    header.innerHTML = value;
    row.appendChild(header);
}

function show_gamestate(elem, value) {
    elem.innerHTML ="";
    var newTable = document.createElement("table");
    newTable.className = "tbl";

    /*
    var nextToAct = newTable.insertRow();
    addHeader(nextToAct, "Next to Act")
    nextToAct.insertCell().innerHTML = value.next_to_act;
    */

    var pot = newTable.insertRow();
    addHeader(pot, "Pot Value")
    pot.insertCell().innerHTML = value.pot;


    elem.appendChild(newTable);

    var playerTable = document.createElement("table");
    playerTable.className = "tbl";

    var name = playerTable.insertRow();
    addHeader(name, "Player");
    addHeader(name, "Current Bet");

    for (var i = 0; i < value.players.length; i++) {
        var player = value.players[i];
        var row = playerTable.insertRow();
        var cell = row.insertCell(0);
        if (player.name == value.next_to_act) {
            cell.innerHTML = "<span class='active'>" + player.name + "</span>";
        } else {
            cell.innerHTML = player.name;
        }

        cell = row.insertCell(1);
        if (player.eligibility == null) {
            cell.innerHTML = "fold";
        } else {
            cell.innerHTML = player.bet;
        }
    }

    elem.appendChild(playerTable);
}

function show_cards(elem, value) {
    elem.innerHTML = "";
    for(var i = 0; i < value.length; i+=2) {
        var out = document.createElement("span");

        var qty = value.charAt(i);
        var suit = value.charAt(i + 1);

        var codepoint = 0x1F0A0;
        switch(qty) {
            case 'A':
                codepoint += 0x1;
                break;
            case 'K':
                codepoint += 0xE;
                break;
            case 'Q':
                codepoint += 0xD;
                break;
            case 'J':
                codepoint += 0xB;
                break;
            case 'X':
                codepoint += 0xA;
                break
            default:
                codepoint += qty.charCodeAt(0) - 0x30;
        }

        var color = "blue";
        switch(suit) {
            case 'H':
                codepoint += 0x10;
                color = "hotpink";
                break;
            case 'D':
                codepoint += 0x20;
                color = "crimson";
                break;
            case "C":
                codepoint += 0x30;
                color = "black";
                break
        }
        out.style.color = color;
        out.innerText = String.fromCodePoint(codepoint);
        console.log(codepoint)
        elem.appendChild(out);
    }
}

function start_game() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/api/room/" + room_name + "/start");
    xhr.send();
}


function fetch_state() {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
        var content_type = xhr.getResponseHeader("Content-Type");
        if(!content_type.startsWith("application/json")) {
            // If it's not valid JSON, give the server time to breathe.
            schedule_fetch(10000);
            return;
        }
        var response = JSON.parse(xhr.responseText);
        next_index = response["index"];
        schedule_fetch(0);

        if(xhr.status != 200 || response.room == null) {
            return;
        }

        var game = response.room.game;
        if (game != null) {
            var game = response.room.game;
            show_cards(hole_cards_elem, game.hole_cards);
            show_cards(community_cards_elem, game.community_cards);
            delete game.hole_cards;
            delete game.community_cards;
        }

        if (!name_set && response.room.name != null) {
            name_elem.value = response.room.name;
            name_set = true;
        }

        show_gamestate(game_elem, game)

        ///game_elem.innerHTML = pretty_print(response.room.game);
        players_elem.innerHTML = pretty_print(response.room.players);
        log_elem.innerHTML = pretty_print(response.room.log);
    };
    xhr.ontimeout = function() {
        schedule_fetch(0);
    };
    xhr.onerror = function() {
        schedule_fetch(10000);
    }
    xhr.open("GET", "/api/room/" + room_name + "?index=" + next_index);
    xhr.timeout = 120000;
    xhr.send();
}
fetch_state();

var bet_input = document.getElementById("bet");
bet_input.addEventListener("keyup", function(event) {
    if(event.keyCode != 13) {
        return;
    }
    var xhr = new XMLHttpRequest();
    var payload = undefined;

    if(bet_input.value.trim() == "fold") {
        xhr.open("POST", "/api/room/" + room_name + "/fold");
    } else {
        var amount = parseInt(bet_input.value);
        payload = JSON.stringify({"amount": amount});
        xhr.open("POST", "/api/room/" + room_name + "/bet");
    }

    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(payload);
});

var name_input = document.getElementById("player_name");
name_input.addEventListener("keyup", function(event) {
    if(event.keyCode != 13) {
        return;
    }
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
        if(xhr.status != 200) {
            alert(xhr.responseText);
            return;
        }
    };

    xhr.open("POST", "/api/room/" + room_name + "/join");
    var payload = JSON.stringify({"name": name_input.value});
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(payload);
});
        </script>
    </body>
</html>
